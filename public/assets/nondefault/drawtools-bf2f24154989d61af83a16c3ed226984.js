// Drawtools.js
// @author Thomas Ramfjord
// This is a fairly complicated javascript app, so I've written down the basic format.  Basically there is an array of shapes (a 
// shape is basically an interface.  See an example for the functions you need to implement).  The function "redraw" draws all the shapes
// the canvas.  The mouse functions on the canvas element are determined by the "state" variable, which is an index of the STATES array.  
// Each "state" in the array is an object with functions for all the mouse callbacks.  At the intersection of shapes and at the end of lines
// and such are Points Of Interest (POIs), which the mouse will jump to when close enough.
//
//  section 1:
//      global variables and constants.  Constants should be all caps.
//    shapes: the variable which contains all the shapes
//
//  section 2:
//      drawing/utility functions.  Here you will find functions to write output like messages, and various utility functions used
//      elsewhere in the code.  Odds and ends can go here.
//    redraw: I redraw all the shapes and write messages and stuff.
//    updatePOIs: goes through each pair of shapes, and adds points of interest where they intersect
//      -poiBlahBlah functions are for finding intersections between a pair of shapes and adding POI's for them
//
//  section 3:
//      -shape utility functions
//      -generic shape definitons (eg. circle, line)
//      -specific shape definitions (eg. protractor)
//
//  section 4:
//      -state definitions (eg. compassState, rulerState, etc)
//
//  section 5:
//      -essentially the main method type code - If you want to draw things on load do it here.
$(function(){function u(){d.clearRect(0,0,a.width,a.height),t>=0&&r[t].draw();for(var b=0;b<q.length;b++)q[b].draw();x()}function v(a){var b=$("#canvas").offset(),c=Math.round(b.left),d=Math.round(b.top);e=a.pageX-c,f=a.pageY-d}function w(b){d.clearRect(0,0,a.width,30),d.font="12pt Calibri",d.fillStyle="black",d.fillText(b,10,25)}function x(){var a="",c="";for(var d=0;d<q.length;d++)q[d].hidden||(a+="<p>"+q[d]+"</p>\n",c+=","+q[d].encode());b.html(a),$("#geometry").attr("value",c.substr(1))}function y(){p=[];var a=$("#startshapes").attr("value"),b=a.split(",");for(var c=0;c<b.length;c++)p.push(K(b[c]));O()}function z(){if(t>=0)r[t].mouseDist()>10&&(t=-1,u());else for(var a=0;a<r.length;a++)r[a].mouseDist()<7&&(t=a,u())}function A(){r=[];for(var a=0;a<q.length;a++){if(q[a].hidden)continue;q[a]instanceof P&&(U(q[a].x1,q[a].y1),U(q[a].x2,q[a].y2)),q[a]instanceof R&&U(q[a].x,q[a].y)}for(var a=0;a<q.length-1;a++)for(var b=a+1;b<q.length;b++){if(q[a].hidden||q[b].hidden)continue;q[a]instanceof R?q[b]instanceof R?D(q[a],q[b]):q[b]instanceof P&&C(q[b],q[a]):q[a]instanceof P&&(q[b]instanceof R?C(q[a],q[b]):q[b]instanceof P&&B(q[a],q[b]))}}function B(a,b){var c=(a.x1-a.x2)*(b.y1-b.y2)-(a.y1-a.y2)*(b.x1-b.x2);if(c==0)return 0;var d=Math.floor(((a.x1*a.y2-a.y1*a.x2)*(b.x1-b.x2)-(a.x1-a.x2)*(b.x1*b.y2-b.y1*b.x2))/c),e=Math.floor(((a.x1*a.y2-a.y1*a.x2)*(b.y1-b.y2)-(a.y1-a.y2)*(b.x1*b.y2-b.y1*b.x2))/c),f=Math.min(Math.max(a.x1,a.x2),Math.max(b.x1,b.x2)),g=Math.min(Math.max(a.y1,a.y2),Math.max(b.y1,b.y2)),h=Math.max(Math.min(a.x1,a.x2),Math.min(b.x1,b.x2)),i=Math.max(Math.min(a.y1,a.y2),Math.min(b.y1,b.y2));h<=d&&d<=f&&i<=e&&e<=g&&U(d,e)}function C(a,b){var c=Math.abs(a.x2-a.x1)<Math.abs(a.y2-a.y1),d=c?a.y1:a.x1,e=c?a.x1:a.y1,f=c?a.y2:a.x2,g=c?a.x2:a.y2,h=c?b.y:b.x,i=c?b.x:b.y,j=(g-e)/(f-d),k=e-j*d,l=e-i-j*d,m=j*j+1,k=2*l*j-2*h,b=l*l+h*h-b.r*b.r,n=k*k-4*m*b;if(n<0)return 0;var o=Math.max(d,f),p=Math.max(e,g),q=Math.min(d,f),r=Math.min(e,g);n=Math.sqrt(n);var s=Math.floor((n-k)/(2*m)),t=Math.floor(j*(s-d)+e);return q<=s&&s<=o&&r<=t&&t<=p&&(c?U(t,s):U(s,t)),n==0?1:(s=Math.floor((0-k-n)/(2*m)),t=Math.floor(j*(s-d)+e),q<=s&&s<=o&&r<=t&&t<=p&&(c?U(t,s):U(s,t)),2)}function D(a,b){var c=H(a.x,a.y,b.x,b.y),d=a.r+b.r-c;if(d<0||c==0)return 0;if(d==0){var e=(b.x-a.x)*(a.r/(a.r+b.r))+a.x,f=(b.y-a.y)*(a.r/(a.r+b.r))+a.y;return U(e,f),1}var g=(a.r*a.r-b.r*b.r+c*c)/(2*c),h=Math.sqrt(a.r*a.r-g*g),e=(b.x-a.x)*(g/c)+a.x,f=(b.y-a.y)*(g/c)+a.y,i=e-h/c*(b.y-a.y),j=e+h/c*(b.y-a.y),k=f+h/c*(b.x-a.x),l=f-h/c*(b.x-a.x);return U(i,k),U(j,l),2}function E(){w("")}function F(a,b,c){d.beginPath(),d.arc(a,b,c,0,2*Math.PI,!1),d.closePath(),d.stroke()}function G(a,b,c,e){d.beginPath(),d.moveTo(a,b),d.lineTo(c,e),d.stroke(),d.closePath()}function H(a,b,c,d){return xdiff=a-c,ydiff=b-d,Math.sqrt(xdiff*xdiff+ydiff*ydiff)}function I(a,b,c){return H(a,b,e,f)<=c}function J(a){a=typeof a!="undefined"?a:!1,this.hidden=a,this.color="Black"}function K(a){var b=a.split(":"),c=b.shift();if(c=="line"){for(var d=0;d<b.length;d++)b[d]=parseInt(b[d]);return new P(b[0],b[1],b[2],b[3])}if(c=="circle")return new R(parseInt(b[0]),parseInt(b[1]),parseFloat(b[2]))}function L(){x(),A(),u()}function M(a){return q.push(a),L(),q.length}function N(a){q.splice(a,1),L()}function O(){q=p.slice(0),L()}function P(a,b,c,d){J.call(this),this.x1=a,this.y1=b,this.x2=c,this.y2=d,this.draw=function(){G(a,b,c,d)},this.set_p2=function(a,b){this.x2=a,this.y2=b,this.draw=function(){G(this.x1,this.y1,a,b)}},this.underMouse=function(){return!1},this.toString=function(){return"(Line from "+a+", "+b+" to "+c+", "+d+")"},this.encode=function(){return"line:"+this.x1+":"+this.y1+":"+this.x2+":"+this.y2}}function Q(a,b,c,d){var e=new P(a,b,c,d);return M(e)}function R(a,b,c){J.call(this),this.x=a,this.y=b,this.r=c,this.draw=function(){F(this.x,this.y,this.r)},this.underMouse=function(){return I(this.x,this.y,this.r)},this.toString=function(){return"(Circle "+a+", "+b+", "+c.toFixed(3)+")"},this.encode=function(){return"circle:"+this.x+":"+this.y+":"+this.r}}function S(a,b,c){return tmp=new R(a,b,c),M(tmp)}function T(a,b){this.x=a,this.y=b,this.active=!1,this.mouseDist=function(){return H(this.x,this.y,e,f)},this.toString=function(){return"(POI "+this.x+", "+this.y+", "+this.mouseDist()},this.draw=function(){d.beginPath(),d.arc(this.x,this.y,10,0,2*Math.PI,!1),d.closePath(),d.fillStyle="green",d.fill()}}function U(a,b){r.push(new T(a,b))}function W(a){typeof n!="undefined"&&n.deactivate(),typeof bc[a]=="undefined"?(alert("undefined newstate: "+a+", "+be(bc)),n=X):n=bc[a],n.activate()}function be(a){s="";for(var b=0;b<a.length;b++)s+=a[b]+"\n";return s}var a=$("#canvas")[0];if(a===undefined)return 0;var b=$("#shapes"),c=$("#message"),d=a.getContext("2d"),e,f,g,h,i=0,j=1,k=2,l=3,m=4,n,o=1,p=[],q=[],r=[],t=-1,V={x:a.width/2,y:a.height/2,theta:0,shapes_i:-1,lastx:-1,lasty:-1,lasttheta:0,addToShapes:function(){return this.shapes_i>=0?this.shapes_i:(this.shapes_i=q.push(this)-1,u(),this.shapes_i)},delFromShapes:function(){this.shapes_i>=0&&(q.splice(this.shapes_i,1),u(),this.shapes_i=-1)},toString:function(){return"(Protractor at "+this.x+", "+this.y+")"},move:function(){this.x-=this.lastx-e,this.y-=this.lasty-f,this.lastx=e,this.lasty=f},rotate:function(){var a=Math.atan2(e-this.x,f-this.y);this.theta-=a-this.lasttheta,this.lasttheta=a},setLasttheta:function(){this.lasttheta=Math.atan2(e-this.x,f-this.y)},draw:function(){var a=50,b=100,c=this.x,e=this.y;d.beginPath(),d.arc(this.x,this.y,5,0,2*Math.PI,!0),d.closePath(),d.stroke(),d.beginPath(),d.arc(this.x,this.y,b,Math.PI+this.theta,2*Math.PI+this.theta,!1),d.arc(this.x,this.y,a,Math.PI+this.theta,2*Math.PI+this.theta,!1);var f=1,g=[2,9,2];for(var h=0;h<g.length;h++){f*=g[h],theta_i=Math.PI/f,myInnerRadius=(b-a)*h/g.length+a;for(var i=1;i<f;i++){var j=i*theta_i+this.theta,k=0-Math.sin(j),l=0-Math.cos(j),m=l*myInnerRadius+this.x,n=k*myInnerRadius+this.y,o=l*b+this.x,p=k*b+this.y;d.moveTo(m,n),d.lineTo(o,p)}}var m=Math.cos(this.theta)*b+this.x,n=Math.sin(this.theta)*b+this.y,o=Math.cos(this.theta+Math.PI)*b+this.x,p=Math.sin(this.theta+Math.PI)*b+this.y;d.moveTo(m,n),d.lineTo(o,p),d.stroke()},underMouse:function(){return I(this.x,this.y,100)}},X={tool:"protractor",on_protractor:!1,mouse_is_down:!1,activate:function(){V.addToShapes()},deactivate:function(){V.delFromShapes()},mousedown:function(){this.mouse_is_down=!0,V.lastx=g,V.lasty=h,this.on_protractor=V.underMouse(),this.on_protractor||V.setLasttheta()},mouseup:function(){this.mouse_is_down=!1},mousemove:function(){this.mouse_is_down&&(this.on_protractor?(V.move(),u()):(V.rotate(),u()))}},Y=function(){return null},Z={tool:"compass",mouse_is_down:!1,usingsetradius:!1,minicircle_i:-1,activate:function(){$("#circlesize").attr("value",""),$("#circlesize").show(),$("#usecirclesize").show()},deactivate:function(){$("#circlesize").hide(),$("#usecirclesize").hide()},mousedown:function(){if(!this.usingSetRadius()){this.mouse_is_down=!0,bd.start();var a=new R(e,f,5);a.hidden=!0,this.minicircle_i=M(a)}},mouseup:function(){if(this.usingsetradius){var a=parseFloat($("#circlesize").attr("value"));if(isNaN(a)||a<0||1e3<a){alert('"'+$("#circlesize").attr("value")+'" is an invalid circle radius - it has to be a number between 0 and 1000');return}}else{q.pop();var a=bd.clear()}S(g,h,a),u(),this.mouse_is_down=!1,$("#circlesize").attr("value",""+a)},mousemove:function(){if(this.mouse_is_down&&!this.usingsetradius){var a=H(e,f,g,h);bd.follow(),u()}},usingSetRadius:function(){return this.usingsetradius=$("#usecirclesize:checked").length==1,this.usingsetradius}},_={mouse_is_down:!1,x:0,y:0,last_dist:"n/a",activate:Y,deactivate:Y,mousedown:function(){this.mouse_is_down=!0,this.x=e,this.y=f,bd.start()},mousemove:function(){var a;this.mouse_is_down?(a="distance from ("+this.x+", "+this.y+") to (",a+=e+", "+f+") = "+H(this.x,this.y,e,f),bd.follow()):a="("+e+", "+f+"), just measured: "+this.last_dist,u()},mouseup:function(){this.mouse_is_down=!1;var a=bd.clear();this.last_dist=a}},ba={x1:e,y1:f,mouse_is_down:!1,activate:Y,deactivate:Y,mousedown:function(){this.mouse_is_down=!0,this.x1=e,this.y1=f,bd.start()},mouseup:function(){this.mouse_is_down=!1,bd.clear(),Q(this.x1,this.y1,e,f),u()},mousemove:function(){var a;this.mouse_is_down?(a="distance from ("+this.x1+", "+this.y1+") to (",a+=e+", "+f+") = "+H(this.x1,this.y1,e,f),bd.follow()):a="center: ("+e+", "+f+")"}},bb={activate:Y,deactivate:Y,mousedown:Y,mouseup:Y,mousemove:Y},bc=[X,Z,_,ba,bb],bd={shape_i:-1,start:function(){if(this.shape_i<0){var a=new P(e,f,e+1,f+1);a.hidden=!0,this.shape_i=q.push(a)-1}},follow:function(){q[this.shape_i].set_p2(e,f),u()},clear:function(){line=q[this.shape_i];var a=H(line.x1,line.y1,line.x2,line.y2);return q.splice(this.shape_i,1),this.shape_i=-1,u(),a}};$("#canvas").mousedown(function(a){g=e,h=f,n.mousedown()}),$("#canvas").mouseup(function(a){n.mouseup()}),$("#canvas").mousemove(function(a){v(a),z(),t>=0&&(e=r[t].x,f=r[t].y),n.mousemove()}),$("#compass").click(function(){W(j)}),$("#protractor").click(function(){W(i)}),$("#ruler").click(function(){W(k)}),$("#line").click(function(){W(l)}),$("#clear").click(function(){O()}),y(),W(j)})