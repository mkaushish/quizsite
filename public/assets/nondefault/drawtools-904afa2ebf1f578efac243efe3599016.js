// Drawtools.js
// @author Thomas Ramfjord
// This is a fairly complicated javascript app, so I've written down the basic format.  Basically there is an array of shapes (a 
// shape is basically an interface.  See an example for the functions you need to implement).  The function "redraw" draws all the shapes
// the canvas.  The mouse functions on the canvas element are determined by the "state" variable, which is an index of the STATES array.  
// Each "state" in the array is an object with functions for all the mouse callbacks.  At the intersection of shapes and at the end of lines
// and such are Points Of Interest (POIs), which the mouse will jump to when close enough.
//
//  section 1:
//      global variables and constants.  Constants should be all caps.
//    shapes: the variable which contains all the shapes
//
//  section 2:
//      drawing/utility functions.  Here you will find functions to write output like messages, and various utility functions used
//      elsewhere in the code.  Odds and ends can go here.
//    redraw: I redraw all the shapes and write messages and stuff.
//    updatePOIs: goes through each pair of shapes, and adds points of interest where they intersect
//      -poiBlahBlah functions are for finding intersections between a pair of shapes and adding POI's for them
//
//  section 3:
//      -shape utility functions
//      -generic shape definitons (eg. circle, line)
//      -specific shape definitions (eg. protractor)
//
//  section 4:
//      -state definitions (eg. compassState, rulerState, etc)
//
//  section 5:
//      -essentially the main method type code - If you want to draw things on load do it here.
$(function(){function y(){d.clearRect(0,0,a.width,a.height),x>=0&&w[x].draw();for(var b=0;b<v.length;b++)v[b].draw()}function z(a){var b=$("#canvas").offset(),c=Math.round(b.left),d=Math.round(b.top);e=a.pageX-c,f=a.pageY-d}function A(b){d.clearRect(0,0,a.width,30),d.font="12pt Calibri",d.fillStyle="black",d.fillText(b,10,25)}function B(){var a="",c="",d=0;for(var e=0;e<v.length;e++)v[e].hidden||(a+='<div class=shape style="background-color:'+m[e]+';" id=s_'+e+" >"+v[e]+"</div>\n",c+=","+v[e].encode());b.html(a),$("#geometry").attr("value",c.substr(1));for(var e=0;e<v.length;e++)v[e].hidden||($("#s_"+e).mouseenter({i:e,color:m[e]},function(a){v[a.data.i].highlight(a.data.color),y()}),$("#s_"+e).mouseleave({i:e},function(a){v[a.data.i].unhilight(),y()}))}function C(){u=[];var a=$("#startshapes").attr("value"),b=a.split(",");for(var c=0;c<b.length;c++)Q(O(b[c]));k=i,l=j,u=v.slice(0),S()}function D(){if(x>=0)w[x].mouseDist()>10&&(x=-1,y());else for(var a=0;a<w.length;a++)w[a].mouseDist()<7&&(x=a,y())}function E(){w=[];for(var a=0;a<v.length;a++){if(v[a].hidden)continue;v[a]instanceof T&&(Y(v[a].x1,v[a].y1),Y(v[a].x2,v[a].y2)),v[a]instanceof V&&Y(v[a].x,v[a].y)}for(var a=0;a<v.length-1;a++)for(var b=a+1;b<v.length;b++){if(v[a].hidden||v[b].hidden)continue;v[a]instanceof V?v[b]instanceof V?H(v[a],v[b]):v[b]instanceof T&&G(v[b],v[a]):v[a]instanceof T&&(v[b]instanceof V?G(v[a],v[b]):v[b]instanceof T&&F(v[a],v[b]))}}function F(a,b){var c=(a.x1-a.x2)*(b.y1-b.y2)-(a.y1-a.y2)*(b.x1-b.x2);if(c==0)return 0;var d=Math.floor(((a.x1*a.y2-a.y1*a.x2)*(b.x1-b.x2)-(a.x1-a.x2)*(b.x1*b.y2-b.y1*b.x2))/c),e=Math.floor(((a.x1*a.y2-a.y1*a.x2)*(b.y1-b.y2)-(a.y1-a.y2)*(b.x1*b.y2-b.y1*b.x2))/c),f=Math.min(Math.max(a.x1,a.x2),Math.max(b.x1,b.x2)),g=Math.min(Math.max(a.y1,a.y2),Math.max(b.y1,b.y2)),h=Math.max(Math.min(a.x1,a.x2),Math.min(b.x1,b.x2)),i=Math.max(Math.min(a.y1,a.y2),Math.min(b.y1,b.y2));h<=d&&d<=f&&i<=e&&e<=g&&Y(d,e)}function G(a,b){var c=Math.abs(a.x2-a.x1)<Math.abs(a.y2-a.y1),d=c?a.y1:a.x1,e=c?a.x1:a.y1,f=c?a.y2:a.x2,g=c?a.x2:a.y2,h=c?b.y:b.x,i=c?b.x:b.y,j=(g-e)/(f-d),k=e-j*d,l=e-i-j*d,m=j*j+1,k=2*l*j-2*h,b=l*l+h*h-b.r*b.r,n=k*k-4*m*b;if(n<0)return 0;var o=Math.max(d,f),p=Math.max(e,g),q=Math.min(d,f),r=Math.min(e,g);n=Math.sqrt(n);var s=Math.floor((n-k)/(2*m)),t=Math.floor(j*(s-d)+e);return q<=s&&s<=o&&r<=t&&t<=p&&(c?Y(t,s):Y(s,t)),n==0?1:(s=Math.floor((0-k-n)/(2*m)),t=Math.floor(j*(s-d)+e),q<=s&&s<=o&&r<=t&&t<=p&&(c?Y(t,s):Y(s,t)),2)}function H(a,b){var c=L(a.x,a.y,b.x,b.y),d=a.r+b.r-c;if(d<0||c==0)return 0;if(d==0){var e=(b.x-a.x)*(a.r/(a.r+b.r))+a.x,f=(b.y-a.y)*(a.r/(a.r+b.r))+a.y;return Y(e,f),1}var g=(a.r*a.r-b.r*b.r+c*c)/(2*c),h=Math.sqrt(a.r*a.r-g*g),e=(b.x-a.x)*(g/c)+a.x,f=(b.y-a.y)*(g/c)+a.y,i=e-h/c*(b.y-a.y),j=e+h/c*(b.y-a.y),k=f+h/c*(b.x-a.x),l=f-h/c*(b.x-a.x);return Y(i,k),Y(j,l),2}function I(){A("")}function J(a,b,c,e,f){e!=undefined&&(d.strokeStyle=e),f!=undefined?d.lineWidth=f:d.lineWidth=1,d.beginPath(),d.arc(a,b,c,0,2*Math.PI,!1),d.closePath(),d.stroke()}function K(a,b,c,e,f,g){f!=undefined&&(d.strokeStyle=f),g!=undefined?d.lineWidth=g:d.lineWidth=1,d.beginPath(),d.moveTo(a,b),d.lineTo(c,e),d.stroke(),d.closePath()}function L(a,b,c,d){return xdiff=a-c,ydiff=b-d,Math.sqrt(xdiff*xdiff+ydiff*ydiff)}function M(a,b,c){return L(a,b,e,f)<=c}function N(a){a=typeof a!="undefined"?a:!1,this.hidden=a,this.color="Black"}function O(a){var b=a.split(":"),c=b.shift();if(c=="line"){for(var d=0;d<b.length;d++)b[d]=parseInt(b[d]);return new T(b[0],b[1],b[2],b[3])}if(c=="circle")return new V(parseInt(b[0]),parseInt(b[1]),parseFloat(b[2]))}function P(){B(),E(),y()}function Q(a){return a instanceof T&&i++,a instanceof V&&j++,v.push(a),P(),v.length}function R(a){v.splice(a,1),P()}function S(){i=k,j=l,v=u.slice(0),P()}function T(a,b,c,d){N.call(this),this.x1=a,this.y1=b,this.x2=c,this.y2=d,this.num=i,this.draw=function(){K(a,b,c,d,"black")},this.highlight=function(e){this.draw=function(){K(a,b,c,d,e,3)}},this.unhilight=function(){this.draw=function(){K(a,b,c,d,"black")}},this.set_p2=function(a,b){this.x2=a,this.y2=b,this.draw=function(){K(this.x1,this.y1,a,b,"black")}},this.underMouse=function(){return!1},this.toString=function(){return"L<sub>"+this.num+"</sub>"},this.encode=function(){return"line:"+this.x1+":"+this.y1+":"+this.x2+":"+this.y2}}function U(a,b,c,d){var e=new T(a,b,c,d);return Q(e)}function V(a,b,c){N.call(this),this.x=a,this.y=b,this.r=c,this.num=j,this.draw=function(){J(this.x,this.y,this.r,"black")},this.highlight=function(a){this.draw=function(){J(this.x,this.y,this.r,a,3)}},this.unhilight=function(){this.draw=function(){J(this.x,this.y,this.r,"black",1)}},this.underMouse=function(){return M(this.x,this.y,this.r)},this.toString=function(){return"C<sub>"+this.num+"</sub>"},this.encode=function(){return"circle:"+this.x+":"+this.y+":"+this.r}}function W(a,b,c){return tmp=new V(a,b,c),Q(tmp)}function X(a,b){this.x=a,this.y=b,this.active=!1,this.mouseDist=function(){return t==ba?L(this.x,this.y,Z.x,Z.y):L(this.x,this.y,e,f)},this.toString=function(){return"(POI "+this.x+", "+this.y+", "+this.mouseDist()},this.draw=function(){d.beginPath(),d.arc(this.x,this.y,10,0,2*Math.PI,!1),d.closePath(),d.fillStyle="green",d.fill()}}function Y(a,b){w.push(new X(a,b))}function _(a){if(t==bg[a])return;$("#tools div").removeClass("selected"),$(bh[a]).addClass("selected"),typeof t!="undefined"&&t.deactivate(),typeof bg[a]=="undefined"?(alert("undefined newstate: "+a+", "+bk(bg)),t=ba):t=bg[a],t.activate()}function bj(){var a=parseFloat($("#circlesize").attr("value"));return isNaN(a)||0>=a?(alert("The radius on the right needs to be a positive number!"),$("#usecirclesize").prop("checked",!1),!1):a>500?(alert("Hey, that's a pretty big radius.  I don't think it will fit on the screen"),$("#usecirclesize").prop("checked",!1),!1):!0}function bk(a){s="";for(var b=0;b<a.length;b++)s+=a[b]+"\n";return s}var a=$("#canvas")[0],b=$("#shapes"),c=$("#message"),d=a.getContext("2d"),e,f,g,h,i=1,j=1,k=1,l=1,m=["green","blue","purple","red","orange","yellow"],n=0,o=1,p=2,q=3,r=4,t,u=[],v=[],w=[],x=-1,Z={x:a.width/2,y:a.height/2,theta:0,shapes_i:-1,lastx:-1,lasty:-1,lasttheta:0,addToShapes:function(){return this.shapes_i>=0?this.shapes_i:(this.shapes_i=v.push(this)-1,y(),this.shapes_i)},delFromShapes:function(){this.shapes_i>=0&&(v.splice(this.shapes_i,1),y(),this.shapes_i=-1)},toString:function(){return"(Protractor at "+this.x+", "+this.y+")"},move:function(){this.x-=this.lastx-e,this.y-=this.lasty-f,this.lastx=e,this.lasty=f},rotate:function(){var a=Math.atan2(e-this.x,f-this.y);this.theta-=a-this.lasttheta,this.lasttheta=a},setLasttheta:function(){this.lasttheta=Math.atan2(e-this.x,f-this.y)},draw:function(){var a=50,b=100,c=this.x,e=this.y;d.beginPath(),d.arc(this.x,this.y,5,0,2*Math.PI,!0),d.closePath(),d.stroke(),d.beginPath(),d.arc(this.x,this.y,b,Math.PI+this.theta,2*Math.PI+this.theta,!1),d.arc(this.x,this.y,a,Math.PI+this.theta,2*Math.PI+this.theta,!1);var f=1,g=[2,9,2];for(var h=0;h<g.length;h++){f*=g[h],theta_i=Math.PI/f,myInnerRadius=(b-a)*h/g.length+a;for(var i=1;i<f;i++){var j=i*theta_i+this.theta,k=0-Math.sin(j),l=0-Math.cos(j),m=l*myInnerRadius+this.x,n=k*myInnerRadius+this.y,o=l*b+this.x,p=k*b+this.y;d.moveTo(m,n),d.lineTo(o,p)}}var m=Math.cos(this.theta)*b+this.x,n=Math.sin(this.theta)*b+this.y,o=Math.cos(this.theta+Math.PI)*b+this.x,p=Math.sin(this.theta+Math.PI)*b+this.y;d.moveTo(m,n),d.lineTo(o,p),d.stroke()},underMouse:function(){return M(this.x,this.y,100)}},ba={tool:"protractor",on_protractor:!1,mouse_is_down:!1,activate:function(){Z.addToShapes()},deactivate:function(){Z.delFromShapes()},mousedown:function(){this.mouse_is_down=!0,Z.lastx=g,Z.lasty=h,this.on_protractor=Z.underMouse(),this.on_protractor||Z.setLasttheta()},mouseup:function(){this.mouse_is_down=!1},mousemove:function(){this.mouse_is_down&&(this.on_protractor?(Z.move(),y()):(Z.rotate(),y()))}},bb=function(){return null},bc={tool:"compass",mouse_is_down:!1,usingsetradius:!1,minicircle_i:-1,useWrittenSize:function(){$("#compass span").attr("style",""),$("#compass span").text("Compass R = "+Math.round(parseFloat($("#circlesize").attr("value")),2)),$("#circlesize").hide()},useMakeSize:function(){$("#compass span").attr("style","border-right:2px solid black;"),$("#compass span").text("Compass"),$("#circlesize").show()},activate:function(){$("#usecirclesize").prop("checked",!1),$("#circlesize").attr("value",""),$("#usecirclesize").show(),this.useMakeSize()},deactivate:function(){$(bh[o]+" span").attr("style",""),$("#compass span").text("Compass"),$("#circlesize").hide(),$("#usecirclesize").hide()},mousedown:function(){if(!this.usingSetRadius()){this.mouse_is_down=!0,bi.start();var a=new V(e,f,5);a.hidden=!0,this.minicircle_i=v.push(a)}},mouseup:function(){if(this.usingsetradius){var a=parseFloat($("#circlesize").attr("value"));if(isNaN(a)||a<0||1e3<a){alert('"'+$("#circlesize").attr("value")+'" is an invalid circle radius - it has to be a number between 0 and 1000');return}}else{v.pop();var a=bi.clear()}W(g,h,a),y(),this.mouse_is_down=!1,$("#circlesize").attr("value",""+a)},mousemove:function(){if(this.mouse_is_down&&!this.usingsetradius){var a=L(e,f,g,h);bi.follow(),y()}},usingSetRadius:function(){return this.usingsetradius=$("#usecirclesize:checked").length==1,this.usingsetradius}},bd={mouse_is_down:!1,x:0,y:0,last_dist:"n/a",activate:bb,deactivate:bb,mousedown:function(){this.mouse_is_down=!0,this.x=e,this.y=f,bi.start()},mousemove:function(){var a;this.mouse_is_down?(a="distance from ("+this.x+", "+this.y+") to (",a+=e+", "+f+") = "+L(this.x,this.y,e,f),bi.follow()):a="("+e+", "+f+"), just measured: "+this.last_dist,y()},mouseup:function(){this.mouse_is_down=!1;var a=bi.clear();this.last_dist=a}},be={x1:e,y1:f,mouse_is_down:!1,activate:bb,deactivate:bb,mousedown:function(){this.mouse_is_down=!0,this.x1=e,this.y1=f,bi.start()},mouseup:function(){this.mouse_is_down=!1,bi.clear(),U(this.x1,this.y1,e,f),y()},mousemove:function(){var a;this.mouse_is_down?(a="distance from ("+this.x1+", "+this.y1+") to (",a+=e+", "+f+") = "+L(this.x1,this.y1,e,f),bi.follow()):a="center: ("+e+", "+f+")"}},bf={activate:bb,deactivate:bb,mousedown:bb,mouseup:bb,mousemove:bb},bg=[ba,bc,bd,be,bf],bh=["#protractor","#compass","#ruler","#line","#blank"],bi={shape_i:-1,start:function(){if(this.shape_i<0){var a=new T(e,f,e+1,f+1);a.hidden=!0,this.shape_i=v.push(a)-1}},follow:function(){v[this.shape_i].set_p2(e,f),y()},clear:function(){line=v[this.shape_i];var a=L(line.x1,line.y1,line.x2,line.y2);return v.splice(this.shape_i,1),this.shape_i=-1,y(),a}};$("#canvas").mousedown(function(a){g=e,h=f,t.mousedown()}),$("#canvas").mouseup(function(a){t.mouseup()}),$("#canvas").mousemove(function(a){z(a),D(),x>=0&&(t==ba?(Z.x=w[x].x,Z.y=w[x].y):(e=w[x].x,f=w[x].y)),t.mousemove()}),$("#compass").click(function(){_(o)}),$("#usecirclesize").click(function(){$("#usecirclesize").prop("checked")?bj()&&bc.useWrittenSize():bc.useMakeSize()}),$("#protractor").click(function(){_(n)}),$("#ruler").click(function(){_(p)}),$("#line").click(function(){_(q)}),$("#clear").click(function(){S()}),C(),_(o)})