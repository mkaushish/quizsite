$(function(){function p(){b.clearRect(0,0,a.width,a.height);for(var c=0;c<n.length;c++)n[c].draw();r()}function q(c){b.clearRect(0,0,a.width,30),b.font="12pt Calibri",b.fillStyle="black",b.fillText(c,10,25)}function r(){b.clearRect(a.width-200,100,a.width,a.height),b.font="9pt Calibri",b.fillStyle="black";for(var c=0;c<n.length;c++)b.fillText(n[c].toString(),a.width-200,130+20*c)}function t(a){s="";for(var b=0;b<n.length;b++)s+=n[b]+"\n";return s}function u(){q("")}function v(a,c,d){b.beginPath(),b.arc(a,c,d,0,2*Math.PI,!1),b.closePath(),b.stroke()}function w(a,c,d,e){b.beginPath(),b.moveTo(a,c),b.lineTo(d,e),b.stroke(),b.closePath()}function x(a,b,c,d){return xdiff=a-c,ydiff=b-d,Math.sqrt(xdiff*xdiff+ydiff*ydiff)}function y(){for(var a=0;a<n.length;a++)if(n[a].underMouse())return n[a];return o}function z(a,b,e){return x(a,b,c,d)<=e}function A(a,b,c,d){this.x1=a,this.y1=b,this.x2=c,this.y2=d,this.draw=function(){w(a,b,c,d)},this.set_p2=function(a,b){this.x2=a,this.y2=b,this.draw=function(){w(this.x1,this.y1,a,b)}},this.underMouse=function(){return!1},this.toString=function(){return"(Line from "+a+", "+b+" to "+c+", "+d+")"}}function B(a,b,c,d){var e=new A(a,b,c,d);return n.push(e)-1}function C(a,b,c){this.x=a,this.y=b,this.r=c,this.draw=function(){v(this.x,this.y,this.r)},this.underMouse=function(){return z(this.x,this.y,this.r)},this.toString=function(){return"(Circle "+a+", "+b+", "+c+")"}}function D(a,b,c){return tmp=new C(a,b,c),n.push(tmp)-1}function E(a,c){this.x=a,this.y=c,this.active=!1,this.toString=function(){return"(IP "+this.x+", "+this.y+", "+this.active?"":"not active)"},this.distance=function(a,b){return x(this.x,this.y,a,b)},this.draw=function(){this.active&&(b.beginPath(),b.arc(this.x,this.y,3,0,2*Math.PI,!1),b.closePath(),b.fillStyle="green",b.fill())}}function G(a,b){}function H(a,b){}function I(a){typeof l!="undefined"&&l.deactivate(),typeof P[a]=="undefined"?(alert("undefined newstate: "+a+", "+t(P)),l=J):l=P[a],l.activate()}var a=$("#canvas")[0],b=a.getContext("2d"),c,d,e,f,g=0,h=1,i=2,j=3,k=4,l,m=1,n=[],o=null,F={x:a.width/2,y:a.height/2,theta:0,shapes_i:-1,lastx:-1,lasty:-1,lasttheta:0,addToShapes:function(){return this.shapes_i>=0?this.shapes_i:(this.shapes_i=n.push(this)-1,p(),this.shapes_i)},delFromShapes:function(){this.shapes_i>=0&&(n.splice(this.shapes_i,1),p(),this.shapes_i=-1)},toString:function(){return"(Protractor at "+this.x+", "+this.y+")"},move:function(){this.x-=this.lastx-c,this.y-=this.lasty-d,this.lastx=c,this.lasty=d},rotate:function(){var a=Math.atan2(c-this.x,d-this.y);this.theta-=a-this.lasttheta,this.lasttheta=a},setLasttheta:function(){this.lasttheta=Math.atan2(c-this.x,d-this.y)},draw:function(){var a=50,c=100,d=this.x,e=this.y;b.beginPath(),b.arc(this.x,this.y,5,0,2*Math.PI,!0),b.closePath(),b.stroke(),b.beginPath(),b.arc(this.x,this.y,c,Math.PI+this.theta,2*Math.PI+this.theta,!1),b.arc(this.x,this.y,a,Math.PI+this.theta,2*Math.PI+this.theta,!1);var f=1,g=[2,9,2];for(var h=0;h<g.length;h++){f*=g[h],theta_i=Math.PI/f,myInnerRadius=(c-a)*h/g.length+a;for(var i=1;i<f;i++){var j=i*theta_i+this.theta,k=0-Math.sin(j),l=0-Math.cos(j),m=l*myInnerRadius+this.x,n=k*myInnerRadius+this.y,o=l*c+this.x,p=k*c+this.y;b.moveTo(m,n),b.lineTo(o,p)}}var m=Math.cos(this.theta)*c+this.x,n=Math.sin(this.theta)*c+this.y,o=Math.cos(this.theta+Math.PI)*c+this.x,p=Math.sin(this.theta+Math.PI)*c+this.y;b.moveTo(m,n),b.lineTo(o,p),b.stroke()},underMouse:function(){return z(this.x,this.y,100)}},J={tool:"protractor",on_protractor:!1,mouse_is_down:!1,activate:function(){F.addToShapes()},deactivate:function(){F.delFromShapes()},mousedown:function(){this.mouse_is_down=!0,F.lastx=e,F.lasty=f,topshape=y(),this.on_protractor=F.underMouse(),this.on_protractor||F.setLasttheta()},mouseup:function(){this.mouse_is_down=!1},mousemove:function(){this.mouse_is_down&&(this.on_protractor?(F.move(),p()):(F.rotate(),p()))}},K=function(){return null},L={tool:"compass",mouse_is_down:!1,line_i:-1,minicircle_i:-1,activate:K,deactivate:K,mousedown:function(){this.mouse_is_down=!0,this.minicircle_i=D(c,d,5),this.line_i=B(c,d,c+1,d+1),p()},mouseup:function(){n.pop(),n.pop();var a=x(e,f,c,d);tmp=new C(e,f,a),n.push(tmp),p(),this.mouse_is_down=!1},mousemove:function(){if(this.mouse_is_down){var a=x(c,d,e,f);message="center: ("+e+", "+f+"), radius:"+a,n[this.line_i]=new A(c,d,e,f),p()}else message="center: ("+c+", "+d+")";q(message)}},M={mouse_is_down:!1,x:0,y:0,last_dist:"n/a",activate:K,deactivate:K,mousedown:function(){this.mouse_is_down=!0,this.x=c,this.y=d,Q.start()},mousemove:function(){var a;this.mouse_is_down?(a="distance from ("+this.x+", "+this.y+") to (",a+=c+", "+d+") = "+x(this.x,this.y,c,d),Q.follow()):a="("+c+", "+d+"), just measured: "+this.last_dist,p(),q(a)},mouseup:function(){this.mouse_is_down=!1;var a=Q.clear();this.last_dist=a}},N={x1:c,y1:d,mouse_is_down:!1,activate:K,deactivate:K,mousedown:function(){this.mouse_is_down=!0,this.x1=c,this.y1=d,Q.start()},mouseup:function(){this.mouse_is_down=!1,Q.clear(),B(this.x1,this.y1,c,d),p()},mousemove:function(){var a;this.mouse_is_down?(a="distance from ("+this.x1+", "+this.y1+") to (",a+=c+", "+d+") = "+x(this.x1,this.y1,c,d),Q.follow()):a="center: ("+c+", "+d+")",q(a)}},O={activate:K,deactivate:K,mousedown:K,mouseup:K,mousemove:K},P=[J,L,M,N,O],Q={shape_i:-1,start:function(){if(this.shape_i<0){var a=new A(c,d,c+1,d+1);this.shape_i=n.push(a)-1}},follow:function(){n[this.shape_i].set_p2(c,d),p()},clear:function(){line=n[this.shape_i];var a=x(line.x1,line.y1,line.x2,line.y2);return n.splice(this.shape_i,1),this.shape_i=-1,p(),a}};$("#canvas").mousedown(function(a){e=c,f=d,l.mousedown()}),$("#canvas").mouseup(function(a){l.mouseup()}),$("#canvas").mousemove(function(a){c=a.pageX-this.offsetLeft,d=a.pageY-this.offsetTop,l.mousemove()}),$("#compass").click(function(){I(h)}),$("#protractor").click(function(){I(g)}),$("#ruler").click(function(){I(i)}),$("#line").click(function(){I(j)}),$("#clear").click(function(){n=[],p()}),B(600,0,600,a.height),mycircle=new C(200,200,60),mycircle2=new C(300,300,60),n=[mycircle,mycircle2],r(),I(h),p()})